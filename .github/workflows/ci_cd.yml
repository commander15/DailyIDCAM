name: CI / CD Pipeline

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]*"   # Only valid semver tags like v1.4.0, v2.0.0-beta.1 etc.
  workflow_dispatch:           # Manual trigger (optional)

env:
  PACKAGE_NAME: Daily IDCAM
  QT_VERSION: 6.9.0
  VM_OS: ubuntu-24.04

jobs:
  cross-build:
    strategy:
      matrix:
        include:
          - platform: Windows
            os: windows-2022
            host: windows
            arch: win64_msvc2022_64
            target: desktop
          - platform: Linux
            os: ubuntu-24.04
            host: linux
            arch: linux_gcc_64
            target: desktop
    runs-on: ${{ matrix.os }}
    env:
      BUILD_DIR: ${{ github.workspace }}/build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: ${{ matrix.host }}
          target: ${{ matrix.target }}
          arch: ${{ matrix.arch }}

      - name: Setup MSVC (Windows only)
        if: matrix.platform == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        run: cmake -S ${{ github.workspace }} -B ${{ env.BUILD_DIR }} -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build ${{ env.BUILD_DIR }} --target all --config Release

      - name: Test
        run: cmake --build ${{ env.BUILD_DIR }} --target test --config Release

      - name: Package
        run: cmake --build ${{ env.BUILD_DIR }} --target package --config Release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-Build
          path: |
            ${{ env.BUILD_DIR }}/*.zip
            ${{ env.BUILD_DIR }}/*.tar.gz
            ${{ env.BUILD_DIR }}/*.deb
            ${{ env.BUILD_DIR }}/*.AppImage
            ${{ env.BUILD_DIR }}/*.run
            ${{ env.BUILD_DIR }}/*.exe

  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: cross-build
    runs-on: ubuntu-24.04

    permissions:
      contents: write  # Needed for creating releases

    outputs:
      version: ${{ steps.tag.outputs.version }}
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      release_note: ${{ steps.release_note.outputs.content }}

    steps:
      - name: Extract version
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Full tag: $TAG, extracted version: $VERSION"

      - name: Download release note
        id: release_note
        run: |
          wget https://raw.githubusercontent.com/${{github.repository}}/refs/heads/main/notes/RELEASE-${{ steps.tag.outputs.version }}.txt
          echo "file=RELEASE-${{ steps.tag.outputs.version }}.txt" >> $GITHUB_OUTPUT

          NOTES_FILE="RELEASE-${{ steps.tag.outputs.version }}.txt"
          if [ ! -f "$NOTES_FILE" ]; then
            echo "Release notes file $NOTES_FILE not found!"
            echo "content=No release notes found for version ${{ steps.tag.outputs.version }}" >> $GITHUB_OUTPUT
          else
            CONTENT=$(cat "$NOTES_FILE")
            echo "content<<EOF" >> $GITHUB_OUTPUT
            echo "$CONTENT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ env.PACKAGE_NAME }} ${{ steps.tag.outputs.version }}
          tag_name: ${{ github.ref_name }}        # Use actual tag (e.g. v1.4.2)
          body_path: ${{ steps.release_notes.outputs.file }}
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          files: |
            ./artifacts/**/*
          make_latest: true

  notify:
    needs: create-release
    runs-on: ubuntu-24.04
    steps:
      - name: Preparing email
        run: echo "${{ needs.create-release.outputs.release_note }}"

      - name: Send notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_ADDRESS }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "${{ env.PACKAGE_NAME }} ${{ needs.create-release.outputs.version }} released!"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_ADDRESS }}
          body: |
            Hello,
            A new version of ${{ env.PACKAGE_NAME }} has been released!

            Version: ${{ needs.create-release.outputs.version }}
            Release page: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}

            ${{ needs.create-release.outputs.release_note }}

            Download: https://github.com/${{ github.repository }}/releases/latest

            Thank you!
